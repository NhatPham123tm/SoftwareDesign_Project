<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <link rel="stylesheet" href="manage.css">
</head>
<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #ebebeb;
      color: black;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      height: 100vh;
      background-color: #2c3e50;
      color: white;
      padding: 20px;
    }

    .menu {
      list-style-type: none;
    }

    .menu li {
      margin-bottom: 20px;
    }

    .menu a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      padding: 13px;
      border-radius: 8px;
    }

    .menu a:hover,
    .menu a.active {
      background-color: #34495e;
    }



    .fart {
      list-style-type: none;
      margin-bottom: 20px;
      color: white;
      display: flex;
      align-items: center;
      text-decoration: none;
      padding: 13px;
      border-radius: 8px;
    }


    .fart:hover
    {
      background-color: #34495e;
    }

    

    .main {
      flex: 1;
      padding: 30px;
    }

    .part {
      display: none;
    }

    .part.active {
      display: block;
    }

    table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background-color: white;
  border-radius: 10px;
  overflow: hidden;
}

thead {
  background-color: #2c3e50;
  color: white;
}

thead th {
  padding: 15px;
  text-align: left;
  font-size: 15px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

tbody td {
  padding: 15px;
  border-bottom: 1px solid #eaeaea;
  font-size: 15px;
}

</style>
<body>
    <div class="container">
        <div class="sidebar">
          <div style="margin-bottom: 20px; font-size: 20px;">Manager</div>
          <ul class="menu">
            <li><a href="#dashboard" class="active">Dashboard</a></li>
            <li><a href="#employees" onclick="employeeload(); return false;">Employees</a></li>
            <li><a href="#forms" onclick="stuff(); return false;">Forms</a></li>
            <li><a href="#">Logout</a></li>
          </ul>
          <a class="fart" href="{% url 'dashboard' %}">Home</a></li>
        </div>
    
        <div class="main">
          <div id="dashboard" class="part active">
            <h2>Dashboard</h2>
            <p>Overview of all system activities and stats.</p>
          </div>
          <div id="employees" class="part">
            <h2>Assign Work to Employees</h2>
            <table>
              <thead>
                  <tr>
                      <th>Employee Name</th>
                      <th>Employee ID</th>
                      <th>Department</th>
                      <th>Assign Work</th>
                  </tr>
              </thead>
              <tbody id="employedTableBody"></tbody>
            </table>
            <br>
            <h2>Employees, Change later to assigned work history or delete!</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>User ID</th>
                        <th>Department</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody"></tbody>
            </table>
          </div>

          <div id="forms" class="part">

            <!-- work in progress to hid depending on what department you are in -->
             
            <div id="trois-dept">
              <h2>Finance Department</h2>
              <h3>Pending</h3>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>User ID</th>
                    <th>PDF</th>
                    <th>PDF Type</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="troisPendingBody"></tbody>
              </table>
            </div>

            <div id="trois-dept">
              <h3>Approved/Rejected</h3>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>User ID</th>
                    <th>PDF</th>
                    <th>PDF Type</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="troisProcessedBody"></tbody>
              </table>
            </div>
            
          
            <div id="ura-dept">
              <h2>Registrar Department</h2>
              <h3>Pending</h3>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>User ID</th>
                    <th>PDF</th>
                    <th>PDF Type</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="uraPendingBody"></tbody>
              </table>
            </div>

          <div id="ura-dept">
            <h3>Approved/Rejected</h3>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Date</th>
                  <th>User ID</th>
                  <th>PDF</th>
                  <th>PDF Type</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="uraProcessedBody"></tbody>
            </table>
          </div>
      </div>
    </div>
    </div>
</body>
<script>
    const links = document.querySelectorAll('.menu a');
    const contentSections = document.querySelectorAll('.part');

    links.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();

        const targetId = this.getAttribute('href').substring(1);

        links.forEach(item => item.classList.remove('active'));
        this.classList.add('active');

        contentSections.forEach(section => {
          section.classList.remove('active');
        });

        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
      });
    });

    function stuff() {
  Promise.all([
    fetch("/api/payroll/").then(r => r.json()),
    fetch("/api/reimburse/").then(r => r.json()),
    fetch("/api/address/").then(r => r.json()),
    fetch("/api/diploma/").then(r => r.json())
  ])
  .then(([payrollData, reimburseData, addressData, diplomaData]) => {
    const troisPending = document.getElementById('troisPendingBody');
    const troisProcessed = document.getElementById('troisProcessedBody');
    const uraPending = document.getElementById('uraPendingBody');
    const uraProcessed = document.getElementById('uraProcessedBody');

    // Clear existing
    troisPending.innerHTML = '';
    troisProcessed.innerHTML = '';
    uraPending.innerHTML = '';
    uraProcessed.innerHTML = '';

    const toyForms = [
      ...payrollData.filter(p => p.status !== "Draft"),
      ...reimburseData.filter(r => r.status !== "Draft")
    ];

    const umperiumForms = [
      ...addressData.filter(a => a.status !== "Draft"),
      ...diplomaData.filter(d => d.status !== "Draft")
    ];

    const sortByDate = (a, b) => 
      new Date(b.date_submitted || b.todays_date || b.today_date) -
      new Date(a.date_submitted || a.todays_date || a.today_date);

    const toyPending = toyForms.filter(f => f.status === "Pending").sort(sortByDate);
    const toyProcessed = toyForms.filter(f => f.status !== "Pending").sort(sortByDate);
    const umpPending = umperiumForms.filter(f => f.status === "Pending").sort(sortByDate);
    const umpProcessed = umperiumForms.filter(f => f.status !== "Pending").sort(sortByDate);

    renderForms(toyPending, troisPending);
    renderForms(toyProcessed, troisProcessed);
    renderForms(umpPending, uraPending);
    renderForms(umpProcessed, uraProcessed);
  })
  .catch(error => console.error("Error loading forms:", error));
}

  function renderForms(dataArray, tbody) {
      dataArray.forEach(form => {
          let formType = "Unknown";
          let viewUrl = "";
          let deleteHandler = "";
          let selectId = "";

          if (form.todays_date) {
              formType = "Payroll Form";
              viewUrl = `/view_payroll_pdf2/${form.id}/`;
              deleteHandler = `deleteForm(${form.id}, 'payroll')`;
              selectId = `statusSelect_payroll_${form.id}`;
          } else if (form.today_date) {
              formType = "Reimburse Form";
              viewUrl = `/view_pdf2/${form.id}/`;
              deleteHandler = `deleteForm(${form.id}, 'reimburse')`;
              selectId = `statusSelect_reimburse_${form.id}`;
          } else if ('street_address' in form) {
              formType = "Change Address Form";
              viewUrl = `/view_change_address_pdf3/${form.id}/`;
              deleteHandler = `deleteForm(${form.id}, 'address')`;
              selectId = `statusSelect_address_${form.id}`;
          } else if ('degree' in form) {
              formType = "Diploma Form";
              viewUrl = `/view-diploma-pdf3/${form.id}/`;
              deleteHandler = `deleteForm(${form.id}, 'diploma')`;
              selectId = `statusSelect_diploma_${form.id}`;
          }

          const options = `
              <option value="Pending" ${form.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Approved">Approve</option>
              <option value="Rejected">Reject</option>
              <option value="Cancelled">Cancel</option>
          `;

          const date = form.date_submitted || form.todays_date || form.today_date || "—";

          tbody.innerHTML += `
              <tr>
                  <td>${form.name || form.employee_name}</td>
                  <td>${date}</td>
                  <td>${form.employee_id || form.user || "N/A"}</td>
                  <td><a href="${viewUrl}" target="_blank">Open PDF</a></td>
                  <td>${formType}</td>
                  <td>
                      <p>${form.status}</p>
                      <select id="${selectId}">${options}</select>
                  </td>
                  <td>
                      <button class="del-button" onclick="${deleteHandler}">Delete</button>
                  </td>
              </tr>`;

          setTimeout(() => {
              const selectElement = document.getElementById(selectId);
              if (selectElement) {
                  selectElement.addEventListener('change', function () {
                      handleStatusChange(form.id, this.value, formType);
                  });
              }
          }, 0);
      });
  }
  // Function to set cookies
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000)); // Expiration time
  const expires = "expires=" + d.toUTCString();
  document.cookie = name + "=" + value + ";" + expires + ";path=/";
}

// Function to get cookies
function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
      let c = ca[i].trim();
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}


// Function to delete cookies
function deleteCookie(name) {
  document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
}

function employeeload() {
  userLoad();
}
async function userLoad() {
  let currUser = localStorage.getItem("user_data");
  let currUserData = JSON.parse(currUser);
  managerRole = {
    id: '',
    level: '',
    role_name: '',
    department: ''
  }

      // Check if the value exists
  if (currUser !== null) {
    console.log("Retrieved value:", currUser);
    console.log("Retrieved value:", currUserData.id);
  } else {
    console.log("No value found for logged in user.");
  }
  await fetch(`/api/users/${currUserData.id}/`)
  .then(response => response.json())
  .then(data => {
    console.log("Retrieved data:", data.role.department);
    managerRole.id = data.role.id;
    managerRole.level = data.role.level;
    managerRole.role_name = data.role.role_name;
    managerRole.department = data.role.department;
  });
  console.log("Retrieved manager:",managerRole.id);
  
  await fetch("/api/get_userLoad/")
  .then(response => response.json())
  .then(data => {
    console.log(data);
      tbody = document.getElementById('employeeTableBody');
      tbody2 = document.getElementById('employedTableBody');
      tbody.innerHTML = '';
      tbody2.innerHTML = '';

      data.users.forEach(user => {
        employyeeLoad = `
          <tr>
              <td>${user.name}</td>
              <td>${user.id}</td>
              <td>${user.role.department}</td>
          </tr>`
        if(user.role.id == managerRole.id + 2 || managerRole.id == 1) {
          if(managerRole.id == 1 && user.role.role_name == 'employee') {
            tbody2.innerHTML += employyeeLoad;
          }
          else if(user.role.department == managerRole.department && user.role.role_name == 'employee') {
            tbody2.innerHTML += employyeeLoad;
          }
          
        }

        if(user.role.id == 2) {
          tbody.innerHTML += `
          <tr>
              <td>${user.name}</td>
              <td>${user.email}</td>
              <td>${user.status}</td>
              <td>${user.role.role_name}</td>
          </tr>`;}
      })
  })
  .catch(error => {
      console.error('Error loading users:', error);
  });
}
</script>
</html>
