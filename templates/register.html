{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link rel="stylesheet" href="{% static 'css/register.css' %}">
</head>
<body>
    <div class="container">
        <h2>Register</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="id">UH ID:</label>
                <input type="text" id="id" placeholder="7 digits" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Min 7 characters" required minlength="7">
            </div>
            <div class="form-group">
                <label for="retypePassword">Confirm Password:</label>
                <input type="password" id="retypePassword" required>
            </div>
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="user_email">Email:</label>
                <input type="email" id="user_email" required>
            </div>
            <div class="microsoft-auth-group">
                <input type="checkbox" id="microsoftAuth" onclick="toggleMicrosoftAuth()">
                <label for="microsoftAuth">Link with Microsoft</label>
            </div>
            <button type="button" id="submitButton" onclick="nextStep()">Submit</button>
        </form>
    </div>

    <!-- Modal for showing messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage">Message goes here...</p>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        function toggleMicrosoftAuth() {
            const isChecked = document.getElementById('microsoftAuth').checked;
            document.getElementById('name').disabled = isChecked;
            document.getElementById('user_email').disabled = isChecked;
            document.getElementById('submitButton').textContent = isChecked ? "Continue with Microsoft" : "Submit";
        }

        function nextStep() {
            const id = document.getElementById('id').value.trim();
            const password = document.getElementById('password').value;
            const retypePassword = document.getElementById('retypePassword').value;
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('user_email').value.trim();
            const microsoftAuth = document.getElementById('microsoftAuth').checked;

            if (!id || !password || !retypePassword) {
                showModal('Please fill in all required fields.');
                return;
            }
            if (password.length < 7) {
                showModal('Password must be at least 7 characters long.');
                return;
            }
            if (password !== retypePassword) {
                showModal('Passwords do not match.');
                return;
            }

            if (!microsoftAuth) {
                if (!name || !email) {
                    showModal('Please fill in all fields.');
                    return;
                }

                const userData = {
                    id,
                    password,
                    name,
                    email
                };

                // Manual form submission
                fetch('/api/user_register/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showModal(data.message);
                    } else {
                        showModal(data.message);
                    }
                })
                .catch(error => {
                    showModal('An error occurred. Please try again.');
                    console.error('Error:', error);
                });

            } else {
                // Microsoft authentication flow
                sessionStorage.setItem('id', id);
                sessionStorage.setItem('password', password);
                window.location.href = '/login/microsoft/';
            }
        }

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').style.display = 'block';
        }

        function closeModal() {
            const modalMessage = document.getElementById('modalMessage').textContent;
            document.getElementById('messageModal').style.display = 'none';

            // Redirect to login page if the registration was successful
            if (modalMessage === 'User registered successfully!') {
                window.location.href = '/login/';
            }
        }

    </script>
</body>
</html>
