{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/reimburst1.css' %}">
    <title>{{ step_title }}</title>
</head>
<body>

    <nav class="top">
        <div class="topbox toplink">
            <a href="{% url 'dashboard' %}">Trois-Rivi√®res</a>
            <div class="dropdown">
                <button class="dropbtn">View</button>
                <div class="dropdown-content">
                  <a href="{% url 'basicuser' %}">Profile</a>
                  <a href="{% url 'forms' %}">Form</a>
                  <a href="{% url 'adminpage' %}" id="admin_link">Admin</a>
                  <a href="#" onclick="logoutUser()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="title4">
        <div class="container">
            <div class="row">
                <h2>{{ step_title }}</h2>
                <form id="diploma-form" method="post">
                    {% csrf_token %}
                    {{ form.as_p }}

                    {% if show_signature %}
                        <label for="signature-pad">Signature:</label>
                        <canvas id="signature-pad" width="400" height="150" style="border:1px solid #000;"></canvas>
                        <br>
                        <button type="button" id="save-signature">Save Signature</button>
                        <br><br>
                        <input type="hidden" name="signature_base64" id="signature_base64">
                        <button type="submit" onclick="return handleSignature()">Submit</button>
                        <button type="button" id="clear-signature">Clear Signature</button>
                    {% else %}
                        <button type="submit">Continue</button>
                    {% endif %}
                </form>

                {% if back_url %}
                    <a href="{% url 'diploma_step1' %}"><button>Back</button></a>
                {% endif %}
                <a href="{% url 'dashboard' %}"><button>Return to dashboard</button></a>
            </div>
        </div>
    </section>

    {% if show_signature %}
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        const canvas = document.getElementById("signature-pad");
        const signaturePad = new SignaturePad(canvas);

        document.getElementById("save-signature").addEventListener("click", function () {
            if (signaturePad.isEmpty()) {
                alert("Please sign before saving.");
            } else {
                document.getElementById("signature_base64").value = signaturePad.toDataURL();
                alert("Signature saved.");
            }
        });

        document.getElementById("clear-signature").addEventListener("click", function () {
            signaturePad.clear();
            document.getElementById("signature_base64").value = "";
        });

        function handleSignature() {
            if (signaturePad.isEmpty()) {
                return confirm("You haven't signed. Submit anyway?");
            }
            document.getElementById("signature_base64").value = signaturePad.toDataURL();
            return true;
        }
    </script>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('/api/microsoft-login/', {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (!localStorage.getItem("access_token")) {
                    localStorage.setItem("access_token", data.access_token);
                    localStorage.setItem("user", JSON.stringify(data.user)); 
                }
                updateUserUI();
            })
            .catch(() => {
                updateUserUI();
            });

            const userData = JSON.parse(localStorage.getItem("user_data") || localStorage.getItem("user") || '{}');
            if (userData.id) {
                const idField = document.getElementById("user_id");
                if (idField) {
                    idField.value = userData.id;
                }
            }
        });

        function updateUserUI() {
            const userData = JSON.parse(localStorage.getItem("user_data") || localStorage.getItem("user") || '{}');
            if (userData.role === 1) {
                document.getElementById("admin_link").style.display = "block";
            } else {
                document.getElementById("admin_link").style.display = "none";
            }

            if (userData.name) {
                const welcome = document.getElementById("welcome");
                if (welcome) {
                    welcome.textContent = `Welcome, ${userData.name} (ID: ${userData.id})!`;
                }
            }
        }

        function logoutUser() {
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            localStorage.removeItem("user");
            localStorage.removeItem("user_data");
            window.location.href = "/logout/";
        }
    </script>
</body>
</html>
